<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-touch-fullscreen" content="yes">
  <title>Universal Screen Viewer</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 10px; 
      color: #333; 
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      overflow-x: hidden;
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(10px); 
      border-radius: 20px; 
      padding: 20px; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); 
    }
    
    h1 { 
      text-align: center; 
      color: #333; 
      font-size: 1.8rem; 
      margin-bottom: 5px; 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
    }
    
    .subtitle { 
      text-align: center; 
      color: #666; 
      margin-bottom: 20px; 
      font-size: 1rem; 
    }
    
    .browser-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    .browser-warning.show {
      display: block;
    }
    
    .browser-warning h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .browser-warning p {
      color: #856404;
      line-height: 1.4;
    }
    
    .input-section { 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      margin-bottom: 20px; 
      align-items: center; 
    }
    
    #sessionInput { 
      width: 100%; 
      max-width: 280px; 
      padding: 15px 20px; 
      font-size: 1.1rem; 
      font-weight: bold; 
      text-align: center; 
      letter-spacing: 1px; 
      border: 2px solid #e1e5e9; 
      border-radius: 12px; 
      background: white; 
      transition: all 0.3s ease; 
      text-transform: uppercase; 
      outline: none;
      -webkit-user-select: text;
      user-select: text;
    }
    
    #sessionInput:focus { 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); 
    }
    
    .connect-btn { 
      width: 100%; 
      max-width: 280px; 
      padding: 15px 25px; 
      background: linear-gradient(135deg, #28a745, #20c997); 
      color: white; 
      border: none; 
      border-radius: 12px; 
      font-size: 1rem; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3); 
      -webkit-tap-highlight-color: transparent; 
      touch-action: manipulation;
    }
    
    .connect-btn:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4); 
    }
    
    .connect-btn:disabled { 
      background: #6c757d; 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
    }
    
    .status-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }
    
    .status-section.show {
      display: block;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      animation: pulse 2s infinite;
    }
    
    .status-dot.connecting { background: #ffc107; }
    .status-dot.error { background: #dc3545; animation: none; }
    
    @keyframes pulse { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.5; } 
    }
    
    .video-section { 
      margin-top: 20px; 
      border-radius: 15px; 
      overflow: hidden; 
      background: #000; 
      position: relative; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
      display: none; 
    }
    
    .video-section.active { 
      display: block; 
    }
    
    #remoteVideo { 
      width: 100%; 
      height: auto; 
      min-height: 200px; 
      max-height: 70vh; 
      object-fit: contain; 
      background: #000; 
      display: block;
    }
    
    .video-overlay {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }
    
    .controls { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      margin-top: 15px; 
      flex-wrap: wrap; 
    }
    
    .control-btn { 
      padding: 10px 15px; 
      background: linear-gradient(135deg, #dc3545, #c82333); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      -webkit-tap-highlight-color: transparent; 
      touch-action: manipulation;
      font-size: 0.9rem;
    }
    
    .control-btn.secondary {
      background: linear-gradient(135deg, #6c757d, #5a6268);
    }
    
    .control-btn.fullscreen {
      background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .error-message { 
      background: #f8d7da; 
      color: #721c24; 
      padding: 15px; 
      border-radius: 8px; 
      margin: 15px 0; 
      display: none; 
      text-align: center; 
      border-left: 4px solid #dc3545; 
    }
    
    .debug-section { 
      background: #e9ecef; 
      padding: 15px; 
      border-radius: 8px; 
      margin: 15px 0; 
      font-family: monospace; 
      font-size: 0.8rem; 
      display: none; 
      max-height: 200px; 
      overflow-y: auto; 
      white-space: pre-wrap;
    }
    
    .loading { 
      text-align: center; 
      padding: 20px; 
      color: #666; 
      display: none; 
    }
    
    .loading-spinner { 
      border: 3px solid #f3f3f3; 
      border-top: 3px solid #667eea; 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 1s linear infinite; 
      margin: 0 auto 10px; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .device-info {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }
    
    @media (max-width: 768px) { 
      body { padding: 10px; } 
      .container { padding: 15px; } 
      h1 { font-size: 1.5rem; } 
      #remoteVideo { max-height: 60vh; }
      .controls { gap: 8px; }
      .control-btn { padding: 8px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üì± Universal Screen Viewer</h1>
  <p class="subtitle">Works on All Devices & Browsers</p>
  
  <!-- Browser compatibility warning -->
  <div class="browser-warning" id="browserWarning">
    <h3>‚ö†Ô∏è Browser Compatibility Notice</h3>
    <p id="browserMessage"></p>
  </div>
  
  <div class="input-section">
    <input type="text" id="sessionInput" placeholder="Enter 6-digit code" maxlength="6" autocomplete="off" inputmode="text">
    <button class="connect-btn" id="connectBtn">üîó Connect to Stream</button>
  </div>

  <div class="device-info" id="deviceInfo"></div>
  
  <!-- Status section -->
  <div class="status-section" id="statusSection">
    <div class="status-indicator">
      <div class="status-dot connecting" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
  </div>

  <div class="error-message" id="errorMessage"></div>
  <div class="debug-section" id="debugSection"></div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>Establishing secure connection...</p>
  </div>

  <div class="video-section" id="videoSection">
    <div class="video-overlay" id="videoOverlay">
      <div class="status-dot" id="overlayStatusDot"></div>
      <span id="overlayStatusText">Connected</span>
    </div>
    <video id="remoteVideo" 
           playsinline 
           webkit-playsinline 
           muted 
           controls></video>
  </div>

  <div class="controls" id="controls" style="display:none;">
    <button class="control-btn" id="disconnectBtn">Disconnect</button>
    <button class="control-btn secondary" id="debugBtn">Show Debug</button>
    <button class="control-btn fullscreen" id="fullscreenBtn">Fullscreen</button>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { ref, get, set, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// DOM Elements
const connectBtn = document.getElementById("connectBtn");
const sessionInput = document.getElementById("sessionInput");
const remoteVideo = document.getElementById("remoteVideo");
const errorMessage = document.getElementById("errorMessage");
const loading = document.getElementById("loading");
const videoSection = document.getElementById("videoSection");
const controls = document.getElementById("controls");
const statusSection = document.getElementById("statusSection");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const overlayStatusDot = document.getElementById("overlayStatusDot");
const overlayStatusText = document.getElementById("overlayStatusText");
const disconnectBtn = document.getElementById("disconnectBtn");
const debugBtn = document.getElementById("debugBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const debugSection = document.getElementById("debugSection");
const browserWarning = document.getElementById("browserWarning");
const browserMessage = document.getElementById("browserMessage");
const deviceInfo = document.getElementById("deviceInfo");

// State management
let currentPC = null;
let currentSessionCode = null;
let debugEnabled = false;
let reconnectAttempts = 0;
let connectionTimeout = null;
const maxReconnectAttempts = 3;
const connectionTimeoutMs = 30000;

// Browser and device detection
const userAgent = navigator.userAgent;
const isIOS = /iPad|iPhone|iPod/.test(userAgent);
const isAndroid = /Android/.test(userAgent);
const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
const isChrome = /Chrome/.test(userAgent);
const isMobile = isIOS || isAndroid;
const isSafariMobile = isIOS && isSafari;

// Enhanced WebRTC configuration with multiple TURN servers
const rtcConfiguration = {
  iceServers: [
    // STUN servers
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun.stunprotocol.org:3478' },
    { urls: 'stun:stun.cloudflare.com:3478' },
    
    // TURN servers for mobile networks
    { 
      urls: 'turn:openrelay.metered.ca:80', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    { 
      urls: 'turn:openrelay.metered.ca:443', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    { 
      urls: 'turn:openrelay.metered.ca:443?transport=tcp', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    {
      urls: 'turn:relay1.expressturn.com:3478',
      username: 'efTAJF7M2TAqVIBR3T',
      credential: 'uxXXDrkXYdkVBdkl'
    }
  ],
  iceCandidatePoolSize: 10,
  iceTransportPolicy: 'all',
  bundlePolicy: 'max-bundle',
  rtcpMuxPolicy: 'require'
};

// Logging function
function log(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${message}`;
  
  console.log(logEntry);
  
  if (debugEnabled) {
    debugSection.textContent += logEntry + '\n';
    debugSection.scrollTop = debugSection.scrollHeight;
  }
}

// Browser compatibility check
function checkBrowserCompatibility() {
  let warningMessage = '';
  let showWarning = false;
  
  if (!window.RTCPeerConnection) {
    warningMessage = 'WebRTC is not supported in this browser. Please use Chrome, Firefox, Safari, or Edge.';
    showWarning = true;
  } else if (isIOS && !isSafari) {
    warningMessage = 'For best experience on iPhone/iPad, please use Safari browser instead of Chrome or other browsers.';
    showWarning = true;
  } else if (isAndroid && !isChrome) {
    warningMessage = 'For best experience on Android, please use Chrome browser.';
    showWarning = true;
  }
  
  if (showWarning) {
    browserMessage.textContent = warningMessage;
    browserWarning.classList.add('show');
  }
  
  // Display device info
  let deviceType = 'Desktop';
  if (isIOS) deviceType = 'iOS (iPhone/iPad)';
  else if (isAndroid) deviceType = 'Android';
  
  let browserType = 'Unknown';
  if (isSafari) browserType = 'Safari';
  else if (isChrome) browserType = 'Chrome';
  else if (userAgent.includes('Firefox')) browserType = 'Firefox';
  else if (userAgent.includes('Edge')) browserType = 'Edge';
  
  deviceInfo.innerHTML = `
    Device: ${deviceType}<br>
    Browser: ${browserType}<br>
    WebRTC: ${window.RTCPeerConnection ? '‚úì Supported' : '‚úó Not Supported'}
  `;
}

// Enhanced error handling
function showError(message, duration = 10000) {
  log(`ERROR: ${message}`, 'error');
  errorMessage.textContent = message;
  errorMessage.style.display = 'block';
  setTimeout(() => {
    errorMessage.style.display = 'none';
  }, duration);
}

// Loading state management
function setLoading(isLoading, message = 'Connecting...') {
  loading.style.display = isLoading ? 'block' : 'none';
  connectBtn.disabled = isLoading;
  connectBtn.textContent = isLoading ? 'Connecting...' : 'üîó Connect to Stream';
  
  if (isLoading) {
    loading.querySelector('p').textContent = message;
  }
}

// Status management
function updateStatus(status, text) {
  const dots = [statusDot, overlayStatusDot];
  dots.forEach(dot => {
    dot.className = `status-dot ${status}`;
  });
  
  statusText.textContent = text;
  overlayStatusText.textContent = text;
  
  if (status !== 'connecting') {
    statusSection.classList.add('show');
  }
  
  log(`Status: ${text}`);
}

// Video element setup with enhanced mobile support
function setupVideo() {
  // Set video properties
  remoteVideo.muted = true;
  remoteVideo.defaultMuted = true;
  remoteVideo.volume = 0;
  remoteVideo.playsInline = true;
  remoteVideo.setAttribute('playsinline', 'true');
  remoteVideo.setAttribute('webkit-playsinline', 'true');
  
  // Video event handlers
  remoteVideo.addEventListener('loadstart', () => log('Video: Load started'));
  remoteVideo.addEventListener('loadeddata', () => log('Video: Data loaded'));
  remoteVideo.addEventListener('loadedmetadata', () => {
    log(`Video: Metadata loaded (${remoteVideo.videoWidth}x${remoteVideo.videoHeight})`);
    playVideo('metadata loaded');
  });
  remoteVideo.addEventListener('canplay', () => {
    log('Video: Can play');
    playVideo('canplay event');
  });
  remoteVideo.addEventListener('playing', () => {
    log('Video: Playing');
    updateStatus('connected', 'Video Playing');
  });
  remoteVideo.addEventListener('pause', () => log('Video: Paused'));
  remoteVideo.addEventListener('waiting', () => log('Video: Waiting'));
  remoteVideo.addEventListener('stalled', () => log('Video: Stalled'));
  remoteVideo.addEventListener('error', (e) => {
    const error = e.target.error;
    log(`Video error: ${error ? error.message : 'Unknown error'}`);
    showError('Video playback error. Please tap to retry or reconnect.');
  });
  
  // User interaction handler for mobile
  remoteVideo.addEventListener('click', () => playVideo('user click'));
  remoteVideo.addEventListener('touchstart', () => playVideo('user touch'));
}

// Enhanced video play function
function playVideo(reason) {
  if (!remoteVideo.srcObject) {
    log(`Play skipped - no source (${reason})`);
    return;
  }
  
  log(`Attempting video play: ${reason}`);
  
  const playPromise = remoteVideo.play();
  
  if (playPromise !== undefined) {
    playPromise.then(() => {
      log(`Video play success: ${reason}`);
      // Remove controls after successful play on desktop
      if (!isMobile) {
        setTimeout(() => {
          remoteVideo.controls = false;
        }, 2000);
      }
    }).catch(error => {
      log(`Video play failed (${reason}): ${error.message}`);
      
      if (error.name === 'NotAllowedError') {
        showError('Please tap the video to start playback');
      }
    });
  }
}

// WebRTC connection establishment
async function connectToSession() {
  const sessionCode = sessionInput.value.trim().toUpperCase();
  
  if (!sessionCode || sessionCode.length !== 6) {
    showError("Please enter a valid 6-digit session code");
    return;
  }
  
  if (!window.RTCPeerConnection) {
    showError("WebRTC is not supported in this browser");
    return;
  }
  
  log(`Starting connection to session: ${sessionCode}`);
  log(`Device: ${isMobile ? 'Mobile' : 'Desktop'}, Browser: ${userAgent.substring(0, 50)}...`);
  
  setLoading(true, 'Connecting to session...');
  updateStatus('connecting', 'Connecting...');
  currentSessionCode = sessionCode;
  reconnectAttempts = 0;
  
  try {
    // Create peer connection
    currentPC = new RTCPeerConnection(rtcConfiguration);
    
    // Set up event handlers
    setupPeerConnectionEvents();
    
    // Check if session exists
    const offerSnapshot = await get(ref(db, `sessions/${sessionCode}/offer`));
    if (!offerSnapshot.exists()) {
      throw new Error("Session not found. Please check the code.");
    }
    
    const offer = offerSnapshot.val();
    log(`Received offer: ${offer.type}`);
    
    // Set remote description
    await currentPC.setRemoteDescription(new RTCSessionDescription(offer));
    log('Remote description set');
    
    // Create and set local description
    const answer = await currentPC.createAnswer({
      offerToReceiveVideo: true,
      offerToReceiveAudio: false
    });
    
    await currentPC.setLocalDescription(answer);
    log('Local description set');
    
    // Send answer to Firebase
    await set(ref(db, `sessions/${sessionCode}/answer`), answer);
    log('Answer sent to Firebase');
    
    // Listen for ICE candidates
    onChildAdded(ref(db, `sessions/${sessionCode}/candidates`), async (snapshot) => {
      if (currentPC && snapshot.val()) {
        try {
          await currentPC.addIceCandidate(new RTCIceCandidate(snapshot.val()));
          log('ICE candidate added');
        } catch (error) {
          log(`ICE candidate error: ${error.message}`);
        }
      }
    });
    
    // Set connection timeout
    connectionTimeout = setTimeout(() => {
      if (currentPC && currentPC.iceConnectionState !== 'connected' && currentPC.iceConnectionState !== 'completed') {
        log('Connection timeout');
        showError('Connection timeout. Please try again.');
        disconnect();
      }
    }, connectionTimeoutMs);
    
  } catch (error) {
    log(`Connection error: ${error.message}`);
    showError(error.message);
    setLoading(false);
    updateStatus('error', 'Connection failed');
  }
}

// Peer connection event handlers
function setupPeerConnectionEvents() {
  // ICE connection state changes
  currentPC.oniceconnectionstatechange = () => {
    const state = currentPC.iceConnectionState;
    log(`ICE connection state: ${state}`);
    
    switch (state) {
      case 'checking':
        updateStatus('connecting', 'Checking connectivity...');
        break;
      case 'connected':
      case 'completed':
        updateStatus('connected', 'Connected');
        setLoading(false);
        reconnectAttempts = 0;
        if (connectionTimeout) {
          clearTimeout(connectionTimeout);
          connectionTimeout = null;
        }
        break;
      case 'disconnected':
        updateStatus('connecting', 'Reconnecting...');
        if (reconnectAttempts < maxReconnectAttempts) {
          setTimeout(() => attemptReconnect(), 2000);
        }
        break;
      case 'failed':
        updateStatus('error', 'Connection failed');
        if (reconnectAttempts < maxReconnectAttempts) {
          setTimeout(() => attemptReconnect(), 3000);
        } else {
          showError('Connection failed after multiple attempts');
          setLoading(false);
        }
        break;
      case 'closed':
        updateStatus('connecting', 'Connection closed');
        break;
    }
  };
  
  // ICE gathering state
  currentPC.onicegatheringstatechange = () => {
    log(`ICE gathering state: ${currentPC.iceGatheringState}`);
  };
  
  // ICE candidates
  currentPC.onicecandidate = (event) => {
    if (event.candidate) {
      log(`ICE candidate: ${event.candidate.type}`);
    } else {
      log('ICE gathering complete');
    }
  };
  
  // Connection state
  currentPC.onconnectionstatechange = () => {
    log(`Peer connection state: ${currentPC.connectionState}`);
  };
  
  // Track received
  currentPC.ontrack = (event) => {
    log('=== TRACK RECEIVED ===');
    const stream = event.streams[0];
    
    if (stream) {
      const videoTracks = stream.getVideoTracks();
      const audioTracks = stream.getAudioTracks();
      
      log(`Stream: ${stream.id}`);
      log(`Video tracks: ${videoTracks.length}`);
      log(`Audio tracks: ${audioTracks.length}`);
      
      if (videoTracks.length > 0) {
        const track = videoTracks[0];
        log(`Video track: ${track.label} (${track.readyState})`);
      }
      
      // Set stream to video element
      remoteVideo.srcObject = stream;
      videoSection.classList.add('active');
      controls.style.display = 'flex';
      
      // Try to play video
      setTimeout(() => {
        playVideo('track received');
      }, 500);
      
      setLoading(false);
    } else {
      log('No stream in track event');
      showError('No video stream received');
    }
  };
}

// Reconnection logic
async function attemptReconnect() {
  if (reconnectAttempts >= maxReconnectAttempts) return;
  
  reconnectAttempts++;
  log(`Reconnect attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
  
  // Clean up current connection
  if (currentPC) {
    currentPC.close();
    currentPC = null;
  }
  
  if (connectionTimeout) {
    clearTimeout(connectionTimeout);
    connectionTimeout = null;
  }
  
  // Wait and retry
  await new Promise(resolve => setTimeout(resolve, 1000));
  await connectToSession();
}

// Disconnect function
function disconnect() {
  log('Disconnecting...');
  
  if (currentPC) {
    currentPC.close();
    currentPC = null;
  }
  
  if (currentSessionCode) {
    off(ref(db, `sessions/${currentSessionCode}/candidates`));
    currentSessionCode = null;
  }
  
  if (connectionTimeout) {
    clearTimeout(connectionTimeout);
    connectionTimeout = null;
  }
  
  remoteVideo.srcObject = null;
  videoSection.classList.remove('active');
  controls.style.display = 'none';
  statusSection.classList.remove('show');
  setLoading(false);
  sessionInput.value = '';
  reconnectAttempts = 0;
  
  updateStatus('connecting', 'Disconnected');
}

// Debug toggle
function toggleDebug() {
  debugEnabled = !debugEnabled;
  debugSection.style.display = debugEnabled ? 'block' : 'none';
  debugBtn.textContent = debugEnabled ? 'Hide Debug' : 'Show Debug';
  
  if (debugEnabled) {
    debugSection.textContent = '=== Debug Log Started ===\n';
    log('Debug mode enabled');
  }
}

// Fullscreen toggle
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    if (remoteVideo.requestFullscreen) {
      remoteVideo.requestFullscreen();
    } else if (remoteVideo.webkitRequestFullscreen) {
      remoteVideo.webkitRequestFullscreen();
    } else if (remoteVideo.msRequestFullscreen) {
      remoteVideo.msRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  }
}

// Input validation
function validateInput() {
  sessionInput.value = sessionInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
}

// Event listeners
sessionInput.addEventListener('input', validateInput);
sessionInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') connectToSession();
});

connectBtn.addEventListener('click', connectToSession);
disconnectBtn.addEventListener('click', disconnect);
debugBtn.addEventListener('click', toggleDebug);
fullscreenBtn.addEventListener('click', toggleFullscreen);

// Mobile-specific event handlers
if (isMobile) {
  // Handle page visibility changes
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && remoteVideo.srcObject && remoteVideo.paused) {
      log('Page visible, attempting video play');
      playVideo('visibility change');
    }
  });
  
  // Handle orientation changes
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (remoteVideo.srcObject) {
        playVideo('orientation change');
      }
    }, 500);
  });
  
  // Handle iOS-specific events
  if (isIOS) {
    window.addEventListener('pageshow', (e) => {
      if (e.persisted && remoteVideo.srcObject) {
        log('iOS pageshow event');
        playVideo('pageshow');
      }
    });
    
    // Use pagehide instead of beforeunload for iOS
    window.addEventListener('pagehide', disconnect);
  } else {
    window.addEventListener('beforeunload', disconnect);
  }
} else {
  window.addEventListener('beforeunload', disconnect);
}

// Global user interaction handler
document.addEventListener('click', () => {
  if (remoteVideo.srcObject && remoteVideo.paused) {
    playVideo('global click');
  }
});

// Initialize
function initialize() {
  log('Initializing Universal Screen Viewer');
  checkBrowserCompatibility();
  setupVideo();
  
  // Auto-focus on input for desktop
  if (!isMobile) {
    sessionInput.focus();
  }
  
  log(`Initialized - Mobile: ${isMobile}, iOS: ${isIOS}, Safari: ${isSafari}`);
}

// Start the application
initialize();
