<!-- viwere.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Screen Viewer</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; 
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
      min-height:100vh; 
      padding:20px; 
      color:#333; 
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .container { 
      max-width:800px; 
      margin:0 auto; 
      background:rgba(255,255,255,0.95); 
      backdrop-filter:blur(10px); 
      border-radius:20px; 
      padding:30px; 
      box-shadow:0 20px 40px rgba(0,0,0,0.1); 
    }
    h2 { 
      text-align:center; 
      color:#333; 
      font-size:2rem; 
      margin-bottom:10px; 
      background:linear-gradient(135deg,#667eea,#764ba2); 
      -webkit-background-clip:text; 
      -webkit-text-fill-color:transparent; 
      background-clip:text; 
    }
    .subtitle { 
      text-align:center; 
      color:#666; 
      margin-bottom:30px; 
      font-size:1.1rem; 
    }
    .input-container { 
      display:flex; 
      flex-direction:column; 
      gap:15px; 
      margin-bottom:30px; 
      align-items:center; 
    }
    #sessionInput { 
      width:100%; 
      max-width:300px; 
      padding:15px 20px; 
      font-size:1.2rem; 
      font-weight:bold; 
      text-align:center; 
      letter-spacing:2px; 
      border:3px solid #e1e5e9; 
      border-radius:12px; 
      background:white; 
      transition:all 0.3s ease; 
      text-transform:uppercase; 
      outline:none;
      -webkit-user-select: text;
      user-select: text;
    }
    #sessionInput:focus { 
      border-color:#667eea; 
      box-shadow:0 0 0 4px rgba(102,126,234,0.2); 
    }
    #joinBtn { 
      width:100%; 
      max-width:300px; 
      padding:15px 25px; 
      background:linear-gradient(135deg,#28a745,#20c997); 
      color:white; 
      border:none; 
      border-radius:12px; 
      font-size:1.1rem; 
      font-weight:600; 
      cursor:pointer; 
      transition:all 0.3s ease; 
      box-shadow:0 8px 20px rgba(40,167,69,0.3); 
      -webkit-tap-highlight-color:transparent; 
      touch-action: manipulation;
    }
    #joinBtn:hover:not(:disabled) { 
      transform:translateY(-2px); 
      box-shadow:0 12px 25px rgba(40,167,69,0.4); 
    }
    #joinBtn:disabled { 
      background:#6c757d; 
      cursor:not-allowed; 
      transform:none; 
      box-shadow:none; 
    }
    .video-container { 
      margin-top:20px; 
      border-radius:15px; 
      overflow:hidden; 
      background:#000; 
      position:relative; 
      box-shadow:0 10px 30px rgba(0,0,0,0.3); 
      display:none; 
    }
    .video-container.active { 
      display:block; 
    }
    #remoteVideo { 
      width:100%; 
      height:auto; 
      min-height:200px; 
      max-height:70vh; 
      object-fit:contain; 
      background:#000; 
      display:block;
    }
    .status-bar { 
      position:absolute; 
      top:15px; 
      left:15px; 
      background:rgba(0,0,0,0.8); 
      color:white; 
      padding:8px 12px; 
      border-radius:20px; 
      font-size:0.9rem; 
      font-weight:500; 
      display:flex; 
      align-items:center; 
      gap:8px; 
      z-index:10; 
    }
    .status-dot { 
      width:8px; 
      height:8px; 
      border-radius:50%; 
      background:#28a745; 
      animation:pulse 2s infinite; 
    }
    .status-dot.connecting { background:#ffc107; }
    .status-dot.error { background:#dc3545; }
    @keyframes pulse { 0%,100% {opacity:1;} 50% {opacity:0.5;} }
    .controls { 
      display:flex; 
      justify-content:center; 
      gap:15px; 
      margin-top:20px; 
      flex-wrap:wrap; 
    }
    .disconnect-btn { 
      padding:10px 20px; 
      background:linear-gradient(135deg,#dc3545,#c82333); 
      color:white; 
      border:none; 
      border-radius:8px; 
      font-weight:600; 
      cursor:pointer; 
      transition:all 0.3s ease; 
      -webkit-tap-highlight-color:transparent; 
      touch-action: manipulation;
    }
    .error-message { 
      background:#f8d7da; 
      color:#721c24; 
      padding:15px; 
      border-radius:8px; 
      margin:15px 0; 
      display:none; 
      text-align:center; 
      border-left:4px solid #dc3545; 
    }
    .ice-status { 
      background:#e9ecef; 
      padding:10px; 
      border-radius:8px; 
      margin:10px 0; 
      font-family:monospace; 
      font-size:0.8rem; 
      display:none; 
      max-height:100px; 
      overflow-y:auto; 
    }
    .loading { 
      text-align:center; 
      padding:20px; 
      color:#666; 
      display:none; 
    }
    .loading-spinner { 
      border:3px solid #f3f3f3; 
      border-top:3px solid #667eea; 
      border-radius:50%; 
      width:40px; 
      height:40px; 
      animation:spin 1s linear infinite; 
      margin:0 auto 10px; 
    }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    
    .device-info {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      display: none;
    }
    
    @media (max-width:768px) { 
      body { padding:15px; } 
      .container { padding:20px; } 
      h2 { font-size:1.6rem; } 
      #remoteVideo { max-height:60vh; }
      .device-info { display: block; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ðŸ“± Screen Viewer</h2>
  <p class="subtitle">Mobile & Desktop Friendly</p>
  
  <div class="input-container">
    <input type="text" id="sessionInput" placeholder="ABCDEF" maxlength="6" autocomplete="off" inputmode="text">
    <button id="joinBtn">ðŸ”— Connect</button>
  </div>

  <div class="device-info" id="deviceInfo">
    Optimized for mobile viewing â€¢ Audio automatically muted
  </div>

  <div class="error-message" id="errorMessage"></div>
  <div class="ice-status" id="iceStatus"></div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>Connecting via TURN servers...</p>
  </div>

  <div class="video-container" id="videoContainer">
    <div class="status-bar" id="statusBar">
      <div class="status-dot connecting" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
    <video id="remoteVideo" playsinline muted webkit-playsinline controls></video>
  </div>

  <div class="controls" id="controls" style="display:none;">
    <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
    <button class="disconnect-btn" id="toggleIceBtn" style="background:#6c757d;">Show ICE</button>
    <button class="disconnect-btn" id="fullscreenBtn" style="background:#007bff;">Fullscreen</button>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import { ref, get, set, push, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const joinBtn = document.getElementById("joinBtn");
const sessionInput = document.getElementById("sessionInput");
const remoteVideo = document.getElementById("remoteVideo");
const errorMessage = document.getElementById("errorMessage");
const loading = document.getElementById("loading");
const videoContainer = document.getElementById("videoContainer");
const controls = document.getElementById("controls");
const statusBar = document.getElementById("statusBar");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const disconnectBtn = document.getElementById("disconnectBtn");
const toggleIceBtn = document.getElementById("toggleIceBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const iceStatus = document.getElementById("iceStatus");
const deviceInfo = document.getElementById("deviceInfo");

let currentPC = null;
let currentSessionCode = null;
let iceDebug = false;
let reconnectAttempts = 0;
const maxReconnectAttempts = 3;

// Enhanced ICE configuration with more TURN servers for mobile reliability
const pcConfig = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' },
    { urls: 'stun:stun.stunprotocol.org:3478' },
    { urls: 'stun:stun.cloudflare.com:3478' },
    { 
      urls: 'turn:openrelay.metered.ca:80', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    { 
      urls: 'turn:openrelay.metered.ca:443', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    { 
      urls: 'turn:openrelay.metered.ca:443?transport=tcp', 
      username: 'openrelayproject', 
      credential: 'openrelayproject' 
    },
    {
      urls: 'turn:turn.anyfirewall.com:443?transport=tcp',
      username: 'webrtc',
      credential: 'webrtc'
    },
    {
      urls: 'turn:relay1.expressturn.com:3478',
      username: 'efTAJF7M2TAqVIBR3T',
      credential: 'uxXXDrkXYdkVBdkl'
    }
  ],
  iceCandidatePoolSize: 10,
  iceTransportPolicy: 'all',
  bundlePolicy: 'max-bundle',
  rtcpMuxPolicy: 'require'
};

// Mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

function logIce(msg) { 
  console.log(`[ICE] ${msg}`); 
  if (iceDebug) { 
    const time = new Date().toLocaleTimeString(); 
    iceStatus.innerHTML += `[${time}] ${msg}<br>`; 
    iceStatus.scrollTop = iceStatus.scrollHeight; 
  } 
}

function showError(msg) {
  errorMessage.textContent = msg; 
  errorMessage.style.display = 'block'; 
  setTimeout(() => { 
    errorMessage.style.display = 'none'; 
  }, 10000);
}

function showLoading(show) { 
  loading.style.display = show ? 'block' : 'none'; 
  joinBtn.disabled = show; 
  joinBtn.textContent = show ? 'Connecting...' : 'ðŸ”— Connect'; 
}

function updateStatus(status, text) { 
  statusDot.className = 'status-dot ' + status; 
  statusText.textContent = text; 
  logIce(`Status: ${text}`); 
}

function showVideoContainer() { 
  videoContainer.classList.add('active'); 
  controls.style.display = 'flex'; 
}

function hideVideoContainer() { 
  videoContainer.classList.remove('active'); 
  controls.style.display = 'none'; 
}

// Enhanced video handling for mobile
function setupVideoElement() {
  // Set all required properties for mobile compatibility
  remoteVideo.muted = true;
  remoteVideo.playsInline = true;
  remoteVideo.autoplay = false; // Disable autoplay, use manual play
  remoteVideo.setAttribute('playsinline', 'true');
  remoteVideo.setAttribute('webkit-playsinline', 'true');
  remoteVideo.setAttribute('muted', 'true');
  remoteVideo.defaultMuted = true;
  remoteVideo.volume = 0;
  
  // Always show controls on mobile for easier debugging
  if (isMobile) {
    remoteVideo.controls = true;
    logIce('Mobile: Video controls enabled for debugging');
  }
  
  // Video event handlers
  remoteVideo.addEventListener('loadstart', () => {
    logIce('Video: Load started');
  });
  
  remoteVideo.addEventListener('loadeddata', () => {
    logIce('Video: Data loaded');
  });
  
  remoteVideo.addEventListener('loadedmetadata', () => {
    logIce(`Video: Metadata loaded - ${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`);
    
    // Manual play attempt
    setTimeout(() => {
      attemptVideoPlay('metadata loaded');
    }, 200);
  });
  
  remoteVideo.addEventListener('canplay', () => { 
    logIce('Video: Can play'); 
    attemptVideoPlay('canplay event');
  });
  
  remoteVideo.addEventListener('playing', () => {
    logIce('Video: Playing started');
    updateStatus('connected', 'Video playing');
  });
  
  remoteVideo.addEventListener('pause', () => {
    logIce('Video: Paused');
  });
  
  remoteVideo.addEventListener('waiting', () => {
    logIce('Video: Waiting for data');
  });
  
  remoteVideo.addEventListener('error', (e) => {
    const error = e.target.error;
    logIce('Video error: ' + (error ? `${error.code} - ${error.message}` : 'Unknown error'));
    showError('Video playback error. Tap to retry or reconnect.');
  });
  
  remoteVideo.addEventListener('stalled', () => {
    logIce('Video: Stalled, attempting to recover');
  });
  
  // Click handler for manual play
  remoteVideo.addEventListener('click', () => {
    attemptVideoPlay('user click');
  });
}

function attemptVideoPlay(reason) {
  if (!remoteVideo.srcObject) {
    logIce(`Play attempt skipped - no source (${reason})`);
    return;
  }
  
  logIce(`Attempting video play: ${reason}`);
  
  const playPromise = remoteVideo.play();
  
  if (playPromise !== undefined) {
    playPromise.then(() => {
      logIce(`Video play successful: ${reason}`);
      // Hide controls after successful play (except on iOS for debugging)
      if (!navigator.userAgent.includes('iPhone') && !navigator.userAgent.includes('iPad')) {
        remoteVideo.controls = false;
      }
    }).catch(e => {
      logIce(`Video play failed (${reason}): ${e.message}`);
      
      if (e.name === 'NotAllowedError') {
        showError('Tap the video to start playback (browser security requirement)');
      } else if (e.name === 'AbortError') {
        logIce('Play aborted, likely due to new play request');
      } else {
        showError('Video playback issue. Please tap the video or reconnect.');
      }
    });
  }
}

function forceVideoPlay() {
  attemptVideoPlay('force play');
}

async function joinSession() {
  const code = sessionInput.value.trim().toUpperCase();
  if (!code || code.length !== 6) { 
    showError("Please enter a valid 6-digit session code"); 
    return;
  }
  
  showLoading(true); 
  errorMessage.style.display = 'none'; 
  logIce(`Starting connection to session: ${code} (Mobile: ${isMobile})`);
  
  try {
    currentPC = new RTCPeerConnection(pcConfig); 
    currentSessionCode = code;
    reconnectAttempts = 0;

    // Enhanced connection state handling
    currentPC.oniceconnectionstatechange = () => {
      const state = currentPC.iceConnectionState;
      logIce(`ICE connection state: ${state}`);
      
      switch (state) {
        case 'checking':
          updateStatus('connecting', 'Checking connectivity...');
          break;
        case 'connected':
        case 'completed':
          updateStatus('connected', 'Connected via ICE');
          showLoading(false);
          reconnectAttempts = 0;
          break;
        case 'disconnected':
          updateStatus('connecting', 'Reconnecting...');
          if (reconnectAttempts < maxReconnectAttempts) {
            setTimeout(() => {
              if (currentPC && currentPC.iceConnectionState === 'disconnected') {
                logIce('Attempting ICE restart...');
                currentPC.restartIce();
                reconnectAttempts++;
              }
            }, 2000);
          }
          break;
        case 'failed':
          updateStatus('error', 'Connection failed');
          if (reconnectAttempts < maxReconnectAttempts) {
            showError(`Connection failed. Retrying... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
            setTimeout(() => attemptReconnect(), 3000);
          } else {
            showError('Connection failed after multiple attempts. Please check your network and try again.');
            showLoading(false);
          }
          break;
        case 'closed':
          updateStatus('connecting', 'Connection closed');
          break;
      }
    };

    currentPC.onicegatheringstatechange = () => { 
      logIce(`ICE gathering state: ${currentPC.iceGatheringState}`); 
    };

    currentPC.onicecandidate = async (event) => { 
      if (event.candidate) { 
        logIce(`New ICE candidate: ${event.candidate.type} (${event.candidate.protocol})`); 
        const viewerCandidatesRef = ref(db, `signaling/${code}/viewerCandidates`);
        await push(viewerCandidatesRef, event.candidate.toJSON());
      } else { 
        logIce('ICE candidate gathering finished'); 
      } 
    };

    currentPC.onconnectionstatechange = () => { 
      const state = currentPC.connectionState; 
      logIce(`Peer connection state: ${state}`); 
    };

    // Enhanced track handling for mobile
    currentPC.ontrack = (event) => {
      logIce('=== TRACK EVENT RECEIVED ===');
      logIce(`Event streams: ${event.streams.length}`);
      logIce(`Event track: ${event.track.kind} - ${event.track.readyState}`);
      
      const stream = event.streams[0];
      
      if (stream) {
        const videoTracks = stream.getVideoTracks();
        const audioTracks = stream.getAudioTracks();
        
        logIce(`Stream ID: ${stream.id}`);
        logIce(`Video tracks: ${videoTracks.length}`);
        logIce(`Audio tracks: ${audioTracks.length}`);
        
        if (videoTracks.length > 0) {
          const videoTrack = videoTracks[0];
          logIce(`Video track: ${videoTrack.label} - ${videoTrack.readyState} - Enabled: ${videoTrack.enabled}`);
        }
        
        // Always set the stream
        remoteVideo.srcObject = stream;
        showVideoContainer();
        updateStatus('connected', 'Stream received');
        
        // Log video element state
        setTimeout(() => {
          logIce(`Video element: ${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`);
          logIce(`Video paused: ${remoteVideo.paused}`);
          logIce(`Video muted: ${remoteVideo.muted}`);
          logIce(`Video readyState: ${remoteVideo.readyState}`);
          
          // Force a play attempt
          attemptVideoPlay('track received');
        }, 500);
        
        showLoading(false);
      } else {
        logIce('ERROR: No stream received in track event');
        showError('Failed to receive video stream');
      }
    };

    // Check if session exists
    const offerSnap = await get(ref(db, `signaling/${code}/offer`));
    if (!offerSnap.exists()) { 
      throw new Error("Session not found. Please check the code and try again."); 
    }

    const offer = offerSnap.val();
    await currentPC.setRemoteDescription(new RTCSessionDescription(offer));

    // Create answer with mobile-specific constraints
    const answerConstraints = {
      offerToReceiveVideo: true,
      offerToReceiveAudio: false
    };

    const answer = await currentPC.createAnswer(answerConstraints);
    await currentPC.setLocalDescription(answer);
    await set(ref(db, `signaling/${code}/answer`), {
      sdp: answer.sdp,
      type: answer.type
    });

    // Listen for ICE candidates from host
    onChildAdded(ref(db, `signaling/${code}/hostCandidates`), async (snap) => {
      if (currentPC && snap.val()) { 
        try { 
          await currentPC.addIceCandidate(new RTCIceCandidate(snap.val())); 
          logIce('ICE candidate added successfully');
        } catch (e) { 
          logIce(`Error adding ICE candidate: ${e.message}`); 
        } 
      }
    });

    // Connection timeout
    setTimeout(() => {
      if (currentPC && currentPC.iceConnectionState !== 'connected' && currentPC.iceConnectionState !== 'completed') {
        logIce('Connection timeout reached');
        showError('Connection timeout. Please try again.');
        showLoading(false);
      }
    }, 30000);

  } catch (error) { 
    logIce(`Connection error: ${error.message}`); 
    showError(error.message || 'Connection failed. Please try again.'); 
    showLoading(false);
  }
}

async function attemptReconnect() {
  if (reconnectAttempts >= maxReconnectAttempts) return;
  
  reconnectAttempts++;
  logIce(`Reconnect attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
  
  // Clean up current connection
  if (currentPC) {
    currentPC.close();
    currentPC = null;
  }
  
  // Wait a moment then retry
  await new Promise(resolve => setTimeout(resolve, 1000));
  await joinSession();
}

function disconnect() { 
  if (currentPC) { 
    currentPC.close(); 
    currentPC = null; 
  } 
  if (currentSessionCode) { 
    off(ref(db, `signaling/${currentSessionCode}/hostCandidates`)); 
    currentSessionCode = null; 
  } 
  remoteVideo.srcObject = null; 
  hideVideoContainer(); 
  showLoading(false); 
  sessionInput.value = ''; 
  updateStatus('connecting', 'Disconnected');
  reconnectAttempts = 0;
}

function toggleIceDebug() { 
  iceDebug = !iceDebug; 
  iceStatus.style.display = iceDebug ? 'block' : 'none'; 
  toggleIceBtn.textContent = iceDebug ? 'Hide ICE' : 'Show ICE'; 
  if (iceDebug) { 
    iceStatus.innerHTML = '=== ICE Debug Started ===<br>'; 
  } 
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    if (remoteVideo.requestFullscreen) {
      remoteVideo.requestFullscreen();
    } else if (remoteVideo.webkitRequestFullscreen) {
      remoteVideo.webkitRequestFullscreen();
    } else if (remoteVideo.msRequestFullscreen) {
      remoteVideo.msRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  }
}

// Event listeners
sessionInput.addEventListener('input', function() { 
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); 
});

sessionInput.addEventListener('keypress', (e) => { 
  if (e.key === 'Enter') { 
    joinSession(); 
  } 
});

joinBtn.onclick = joinSession;
disconnectBtn.onclick = disconnect;
toggleIceBtn.onclick = toggleIceDebug;
fullscreenBtn.onclick = toggleFullscreen;

// Initialize video element
setupVideoElement();

// Handle page visibility changes (mobile background/foreground)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && currentPC && remoteVideo.srcObject) {
    logIce('Page became visible, ensuring video plays');
    remoteVideo.play().catch(e => logIce('Visibility play failed: ' + e.message));
  }
});

// Handle mobile orientation changes
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    if (remoteVideo.srcObject) {
      remoteVideo.play().catch(e => logIce('Orientation play failed: ' + e.message));
    }
  }, 500);
});

// Cleanup on page unload
window.addEventListener('beforeunload', disconnect);

// User interaction handler for mobile autoplay
let userInteracted = false;
function handleUserInteraction() {
  if (!userInteracted) {
    userInteracted = true;
    logIce('User interaction detected');
    if (remoteVideo.srcObject && remoteVideo.paused) {
      remoteVideo.play().then(() => {
        logIce('Video resumed after user interaction');
        // Remove controls after successful play on iOS
        if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
          setTimeout(() => {
            remoteVideo.controls = false;
          }, 2000);
        }
      }).catch(e => logIce('User interaction play failed: ' + e.message));
    }
  }
}

document.addEventListener('touchstart', handleUserInteraction);
document.addEventListener('click', handleUserInteraction);

// iOS specific workarounds
if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
  logIce('iOS device detected, applying iOS-specific workarounds');
  
  // Handle iOS app state changes
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && remoteVideo.srcObject) {
      logIce('iOS: App became visible, checking video state');
      setTimeout(() => {
        if (remoteVideo.paused) {
          logIce('iOS: Video paused, attempting to resume');
          remoteVideo.play().catch(e => logIce('iOS: Resume failed: ' + e.message));
        }
      }, 500);
    }
  });
  
  // Handle iOS Safari specific events
  window.addEventListener('pageshow', () => {
    if (remoteVideo.srcObject && remoteVideo.paused) {
      logIce('iOS: Page shown, attempting video play');
      remoteVideo.play().catch(e => logIce('iOS: Page show play failed: ' + e.message));
    }
  });
}

// Initialize
logIce(`Viewer initialized (Mobile: ${isMobile}, User Agent: ${navigator.userAgent.substring(0, 50)}...)`);

// Display device info for debugging
if (isMobile) {
  deviceInfo.innerHTML = `
    Mobile Device Detected<br>
    ${navigator.userAgent.includes('iPhone') ? 'iOS Safari' : 'Android Chrome'}<br>
    Audio: Muted | Playsinline: Enabled
  `;
}
</script>
<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/689782258b3b22192a593919/1j27t8oof';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->
</body>
</html>
